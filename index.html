<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Vault - Crypto Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: white;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
        }
        
        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .notification {
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .notification.show { transform: translateY(0); }

        input::placeholder { color: rgba(255,255,255,0.3); }
    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="toast" class="notification fixed top-4 left-4 right-4 z-[300] glass p-4 rounded-2xl flex items-center gap-3 border-l-4 border-l-blue-500 shadow-2xl pointer-events-none">
        <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="flex-1">
            <p id="toast-msg" class="text-sm font-medium">System active</p>
        </div>
    </div>

    <div class="w-full max-w-md h-full bg-[#0a0a0a] relative flex flex-col mx-auto shadow-2xl border-x border-white/5 overflow-hidden">
        
        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="absolute inset-0 z-[60] bg-[#0a0a0a] p-8 flex flex-col justify-center transition-all duration-500">
            <div class="mb-12 text-center">
                <div class="w-20 h-20 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="fas fa-shield-halved text-4xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">Nexus Vault</h1>
                <p class="text-gray-400">Secure Peer-to-Peer Wallet</p>
            </div>

            <div id="auth-actions" class="space-y-4">
                <div id="setup-view">
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 block">Account Name</label>
                    <input type="text" id="wallet-name-input" placeholder="e.g. Satoshi" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-blue-500 transition-colors text-white mb-4">
                    <button id="btn-create" class="w-full btn-gradient py-4 rounded-xl font-bold text-lg">Create Individual Account</button>
                    
                    <div class="relative py-6">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                        <div class="relative flex justify-center text-xs uppercase"><span class="bg-[#0a0a0a] px-2 text-gray-500">Restore Session</span></div>
                    </div>

                    <input type="text" id="sync-code-input" placeholder="Enter Sync ID" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-blue-500 transition-colors text-white mb-4 text-center font-mono">
                    <button id="btn-sync" class="w-full bg-white/10 py-3 rounded-xl font-bold hover:bg-white/20">Login to Vault</button>
                </div>
            </div>

            <div id="auth-loading" class="hidden text-center">
                <div class="w-12 h-12 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
                <p id="loading-text" class="text-sm text-gray-400">Syncing with blockchain...</p>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="main-app" class="hidden flex-col h-full relative">
            
            <div class="p-6 flex justify-between items-center flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div id="user-avatar" class="w-9 h-9 rounded-full bg-blue-600 flex items-center justify-center text-sm font-bold">U</div>
                    <div>
                        <span id="display-wallet-name" class="font-bold text-sm block">Loading...</span>
                        <span id="sync-code-display" class="text-[10px] text-blue-500 font-mono font-bold">ID: ...</span>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-gray-400">
                    <i class="fas fa-qrcode cursor-pointer hover:text-white" onclick="showModal('receive-modal')"></i>
                    <i class="fas fa-power-off cursor-pointer hover:text-white" onclick="handleLogout()"></i>
                </div>
            </div>

            <div class="scroll-container">
                <!-- Balance Section -->
                <div class="px-6 py-4">
                    <span class="text-gray-400 text-sm font-medium">Available Balance</span>
                    <h2 id="total-balance" class="text-4xl font-bold tracking-tight mt-1">$0.00</h2>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span class="text-gray-500 text-xs font-medium">Live Cloud Sync</span>
                    </div>
                </div>

                <!-- Action Grid -->
                <div class="grid grid-cols-4 gap-4 px-6 py-6">
                    <div class="flex flex-col items-center gap-2 cursor-pointer" onclick="showModal('send-modal')">
                        <div class="w-12 h-12 rounded-full glass flex items-center justify-center text-blue-400 text-xl"><i class="fas fa-paper-plane"></i></div>
                        <span class="text-[11px] font-semibold text-gray-400 uppercase">Send</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 cursor-pointer" onclick="showModal('receive-modal')">
                        <div class="w-12 h-12 rounded-full glass flex items-center justify-center text-blue-400 text-xl"><i class="fas fa-qrcode"></i></div>
                        <span class="text-[11px] font-semibold text-gray-400 uppercase">Receive</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 opacity-50 cursor-not-allowed">
                        <div class="w-12 h-12 rounded-full glass flex items-center justify-center text-blue-400 text-xl"><i class="fas fa-repeat"></i></div>
                        <span class="text-[11px] font-semibold text-gray-400 uppercase">Swap</span>
                    </div>
                    <div class="flex flex-col items-center gap-2 opacity-50 cursor-not-allowed">
                        <div class="w-12 h-12 rounded-full glass flex items-center justify-center text-blue-400 text-xl"><i class="fas fa-plus"></i></div>
                        <span class="text-[11px] font-semibold text-gray-400 uppercase">Add</span>
                    </div>
                </div>

                <!-- History -->
                <div class="px-6">
                    <h3 class="font-bold text-lg mb-4">Activity</h3>
                    <div id="history-list" class="space-y-3 pb-24">
                        <!-- List populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Bottom Nav -->
            <div class="fixed-nav glass h-20 px-10 flex justify-between items-center border-t border-white/10 bg-[#0a0a0a]/90 z-50">
                <div class="flex flex-col items-center gap-1 text-blue-500 cursor-pointer">
                    <i class="fas fa-wallet text-xl"></i>
                    <span class="text-[10px] font-bold">Vault</span>
                </div>
                <div class="flex flex-col items-center gap-1 text-gray-500 cursor-pointer" onclick="showToast('Market coming soon')">
                    <i class="fas fa-chart-line text-xl"></i>
                    <span class="text-[10px]">Market</span>
                </div>
                <div class="flex flex-col items-center gap-1 text-gray-500 cursor-pointer" onclick="showToast('Settings coming soon')">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-[10px]">Settings</span>
                </div>
            </div>
        </div>

        <!-- SEND MODAL -->
        <div id="send-modal" class="hidden absolute inset-0 z-[150] bg-[#0a0a0a] flex flex-col">
            <div class="p-6 flex items-center gap-4 border-b border-white/5">
                <i class="fas fa-arrow-left text-gray-400 cursor-pointer" onclick="hideModal('send-modal')"></i>
                <h3 class="text-xl font-bold">Send Funds</h3>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Recipient Sync ID</label>
                    <input type="text" id="send-target-id" placeholder="Paste their Sync ID here" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-blue-500 text-sm font-mono">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Amount ($)</label>
                    <input type="number" id="send-amount" placeholder="0.00" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-blue-500 text-2xl font-bold">
                </div>
                <button id="btn-confirm-send" class="w-full btn-gradient py-4 rounded-xl font-bold text-lg shadow-xl">Confirm Transfer</button>
                <p class="text-[10px] text-gray-500 text-center">Cloud transfers are instant and irreversible.</p>
            </div>
        </div>

        <!-- RECEIVE MODAL -->
        <div id="receive-modal" class="hidden absolute inset-0 z-[150] bg-black/95 flex items-center justify-center p-8">
            <div class="w-full bg-[#111] p-8 rounded-3xl text-center border border-white/10">
                <h3 class="font-bold text-xl mb-6">Your Sync ID</h3>
                <div class="bg-white p-4 rounded-2xl inline-block mb-6">
                    <i class="fas fa-qrcode text-8xl text-black"></i>
                </div>
                <p class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-widest">Personal Identification Code</p>
                <div id="my-sync-id" class="text-sm font-mono font-bold text-blue-400 bg-blue-500/5 p-4 rounded-xl border border-blue-500/20 mb-6 break-all">...</div>
                <button onclick="copyToClipboard('my-sync-id')" class="w-full btn-gradient py-4 rounded-xl font-bold text-sm mb-3">Copy Sync ID</button>
                <button onclick="hideModal('receive-modal')" class="w-full text-gray-500 font-medium py-2">Close</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion, runTransaction } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-vault';

        let currentUserData = null;
        let currentUserId = null;

        // UI Helpers
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id).classList.add('hidden');
        window.copyToClipboard = (id) => {
            const text = document.getElementById(id).innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("Copied to clipboard!");
        };

        window.handleLogout = () => {
            if(confirm("Logout? Make sure you have your Sync ID saved!")) {
                localStorage.removeItem('nexus_vault_user_id');
                location.reload();
            }
        };

        // Backend Core Functions
        const initUser = async (name, existingId = null) => {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('auth-loading').classList.remove('hidden');

            const uid = existingId || auth.currentUser.uid;
            currentUserId = uid;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            
            try {
                const snap = await getDoc(userRef);
                if (!snap.exists()) {
                    if (existingId) {
                        showToast("Invalid Sync ID");
                        resetAuthUI();
                        return;
                    }
                    // Create new individual account
                    await setDoc(userRef, {
                        name: name || 'Anonymous User',
                        balance: 1000.00, // Starting bonus
                        history: [{ type: 'in', label: 'Welcome Bonus', amount: '1,000.00', date: new Date().toLocaleDateString() }],
                        created: Date.now()
                    });
                }
                
                localStorage.setItem('nexus_vault_user_id', uid);
                startSyncListener(uid);
            } catch (e) {
                showToast("Connection error");
                resetAuthUI();
            }
        };

        const resetAuthUI = () => {
            document.getElementById('setup-view').classList.remove('hidden');
            document.getElementById('auth-loading').classList.add('hidden');
        };

        const startSyncListener = (uid) => {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            onSnapshot(userRef, (snapshot) => {
                const data = snapshot.data();
                if (data) {
                    currentUserData = data;
                    updateDashboard(uid, data);
                }
            }, (err) => showToast("Sync Error"));
        };

        const updateDashboard = (uid, data) => {
            document.getElementById('display-wallet-name').innerText = data.name;
            document.getElementById('user-avatar').innerText = data.name.charAt(0).toUpperCase();
            document.getElementById('total-balance').innerText = `$${data.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('sync-code-display').innerText = `ID: ${uid.substring(0,8).toUpperCase()}...`;
            document.getElementById('my-sync-id').innerText = uid;

            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...data.history].reverse().forEach(tx => {
                const isPlus = tx.type === 'in';
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/10">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${isPlus ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'} flex items-center justify-center">
                                <i class="fas ${isPlus ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm">${tx.label}</div>
                                <div class="text-[10px] text-gray-500">${tx.date}</div>
                            </div>
                        </div>
                        <div class="text-right font-bold ${isPlus ? 'text-green-500' : 'text-red-500'}">
                            ${isPlus ? '+' : '-'}$${tx.amount}
                        </div>
                    </div>
                `;
            });

            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.replace('hidden', 'flex');
        };

        // THE TRANSFER LOGIC (Peer-to-Peer)
        const processTransfer = async () => {
            const targetId = document.getElementById('send-target-id').value.trim();
            const amountStr = document.getElementById('send-amount').value;
            const amount = parseFloat(amountStr);

            if (!targetId || targetId === currentUserId) {
                showToast("Invalid Target ID");
                return;
            }
            if (isNaN(amount) || amount <= 0 || amount > currentUserData.balance) {
                showToast("Invalid Amount");
                return;
            }

            const btn = document.getElementById('btn-confirm-send');
            btn.disabled = true;
            btn.innerText = "Processing...";

            try {
                await runTransaction(db, async (transaction) => {
                    const senderRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUserId);
                    const receiverRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId);

                    const receiverSnap = await transaction.get(receiverRef);
                    if (!receiverSnap.exists()) {
                        throw "User not found";
                    }

                    const senderSnap = await transaction.get(senderRef);
                    const newSenderBal = senderSnap.data().balance - amount;
                    const newReceiverBal = receiverSnap.data().balance + amount;

                    const date = new Date().toLocaleDateString();

                    transaction.update(senderRef, {
                        balance: newSenderBal,
                        history: arrayUnion({ type: 'out', label: `Sent to ...${targetId.slice(-4)}`, amount: amount.toFixed(2), date })
                    });

                    transaction.update(receiverRef, {
                        balance: newReceiverBal,
                        history: arrayUnion({ type: 'in', label: `From ...${currentUserId.slice(-4)}`, amount: amount.toFixed(2), date })
                    });
                });

                showToast("Transfer Successful!");
                hideModal('send-modal');
                document.getElementById('send-target-id').value = '';
                document.getElementById('send-amount').value = '';
            } catch (e) {
                showToast(e === "User not found" ? "Recipient ID not found" : "Transfer Failed");
            } finally {
                btn.disabled = false;
                btn.innerText = "Confirm Transfer";
            }
        };

        // Bootstrap
        const startup = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const savedId = localStorage.getItem('nexus_vault_user_id');
                        if (savedId) initUser(null, savedId);
                    }
                });
            } catch (err) {
                showToast("Server unreachable");
            }
        };

        startup();

        // Event Listeners
        document.getElementById('btn-create').onclick = () => {
            const name = document.getElementById('wallet-name-input').value.trim();
            if (name) initUser(name);
            else showToast("Enter a name");
        };

        document.getElementById('btn-sync').onclick = () => {
            const code = document.getElementById('sync-code-input').value.trim();
            if (code) initUser(null, code);
            else showToast("Enter Sync ID");
        };

        document.getElementById('btn-confirm-send').onclick = processTransfer;

    </script>
</body>
</html>
