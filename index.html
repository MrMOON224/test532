<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phantom Mobile Fullstack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: white; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .mobile-viewport { width: 100%; max-width: 400px; height: 100vh; max-height: 850px; background: #111; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 640px) { .mobile-viewport { border: 1px solid #333; border-radius: 40px; } }
        .phantom-gradient { background: linear-gradient(135deg, #ab9ff2 0%, #4e44ce 100%); }
        .tab-active { color: #ab9ff2; }
        input:focus { outline: none; border-color: #ab9ff2; }
        .loader { border: 2px solid #333; border-top: 2px solid #ab9ff2; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="mobile-viewport" id="app">
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="absolute inset-0 z-50 bg-black flex items-center justify-center hidden">
            <div class="loader"></div>
        </div>

        <!-- Auth Screen -->
        <div id="auth-screen" class="h-full w-full flex flex-col items-center justify-center p-8 animate__animated animate__fadeIn">
            <div class="w-16 h-16 phantom-gradient rounded-2xl flex items-center justify-center shadow-lg mb-8">
                <svg width="32" height="32" viewBox="0 0 128 128" fill="white"><path d="M64 0C28.7 0 0 28.7 0 64s28.7 64 64 64 64-28.7 64-64S99.3 0 64 0zm0 112c-26.5 0-48-21.5-48-48S37.5 16 64 16s48 21.5 48 48-21.5 48-48 48z"/></svg>
            </div>
            <h1 class="text-3xl font-bold mb-2">Phantom</h1>
            <p id="auth-subtitle" class="text-gray-400 text-center text-sm mb-8 px-4">Securely access your digital assets.</p>

            <div class="w-full space-y-4">
                <!-- Login Form -->
                <div id="login-form">
                    <input type="text" id="login-username" placeholder="Username" class="w-full bg-[#222] border border-transparent rounded-xl px-4 py-4 mb-3 text-white">
                    <input type="password" id="login-password" placeholder="Password" class="w-full bg-[#222] border border-transparent rounded-xl px-4 py-4 mb-4 text-white">
                    <button onclick="signIn()" class="w-full bg-[#ab9ff2] text-black font-bold py-4 rounded-xl hover:bg-[#c1b8f5] transition-colors">Unlock Wallet</button>
                    <button onclick="toggleAuth('signup')" class="w-full text-purple-400 font-semibold mt-4 text-sm">Create new account</button>
                    
                    <div class="mt-8 pt-6 border-t border-white/5">
                        <button onclick="showSQL()" class="w-full text-gray-600 text-[10px] uppercase font-bold tracking-widest hover:text-gray-400 transition-colors">Get Database SQL Setup</button>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <input type="text" id="signup-username" placeholder="Choose Username" class="w-full bg-[#222] border border-transparent rounded-xl px-4 py-4 mb-3 text-white">
                    <input type="password" id="signup-password" placeholder="Set Password" class="w-full bg-[#222] border border-transparent rounded-xl px-4 py-4 mb-4 text-white">
                    <button onclick="signUp()" class="w-full bg-[#ab9ff2] text-black font-bold py-4 rounded-xl">Register Wallet</button>
                    <button onclick="toggleAuth('login')" class="w-full text-purple-400 font-semibold mt-4 text-sm">Back to login</button>
                </div>
            </div>
        </div>

        <!-- SQL Modal -->
        <div id="sql-modal" class="absolute inset-0 z-[60] bg-black/95 p-6 flex flex-col hidden animate__animated animate__fadeIn">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-purple-400 text-sm">Supabase Setup Guide</h3>
                <button onclick="document.getElementById('sql-modal').classList.add('hidden')" class="text-gray-500 text-xl">✕</button>
            </div>
            <p class="text-[11px] text-gray-300 mb-4 bg-purple-900/20 p-3 rounded-lg border border-purple-500/30">
                <b>FINAL FIX FOR 23502:</b> Run this script to completely remove the 'phrase' requirement and refresh the server cache.
            </p>
            <div class="flex-1 overflow-auto bg-[#0a0a0a] rounded-xl p-4 border border-white/10">
                <pre id="sql-content" class="text-[9px] font-mono text-gray-400 leading-relaxed"></pre>
            </div>
            <button onclick="copySQL()" class="w-full bg-white text-black font-bold py-3 rounded-xl mt-4 text-xs">Copy SQL Code</button>
        </div>

        <!-- Main Screen -->
        <div id="main-screen" class="hidden h-full flex flex-col animate__animated animate__fadeIn">
            <header class="p-4 flex items-center justify-between border-b border-white/5 bg-[#111]">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 phantom-gradient rounded-lg flex items-center justify-center font-bold text-xs shadow-inner">P</div>
                    <div>
                        <p id="user-display" class="text-xs font-bold leading-none mb-1"></p>
                        <p class="text-[10px] text-green-400 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Mainnet Beta
                        </p>
                    </div>
                </div>
                <button onclick="signOut()" class="text-gray-500 hover:text-red-400 transition-colors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg></button>
            </header>

            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar" id="view-container">
                <!-- Dashboard -->
                <div id="view-dashboard">
                    <div class="text-center py-10">
                        <p id="balance-usd" class="text-4xl font-bold mb-1 tracking-tight">$0.00</p>
                        <p class="text-gray-500 text-sm font-medium">Portfolio Balance</p>
                    </div>

                    <div class="flex gap-4 mb-8">
                        <button onclick="switchView('send')" class="flex-1 flex flex-col items-center gap-2 group">
                            <div class="w-12 h-12 bg-[#ab9ff2] text-black rounded-full flex items-center justify-center font-bold group-active:scale-95 transition-transform">↑</div>
                            <span class="text-[10px] font-bold text-gray-500">Send</span>
                        </button>
                        <button class="flex-1 flex flex-col items-center gap-2 group">
                            <div class="w-12 h-12 bg-[#222] text-[#ab9ff2] rounded-full flex items-center justify-center font-bold group-active:scale-95 transition-transform">↓</div>
                            <span class="text-[10px] font-bold text-gray-500">Receive</span>
                        </button>
                        <button class="flex-1 flex flex-col items-center gap-2 group opacity-50">
                            <div class="w-12 h-12 bg-[#222] text-gray-400 rounded-full flex items-center justify-center font-bold">⇄</div>
                            <span class="text-[10px] font-bold text-gray-500">Swap</span>
                        </button>
                    </div>

                    <div class="bg-[#1a1a1a] rounded-2xl p-4 flex items-center justify-between border border-white/5">
                        <div class="flex items-center gap-3">
                            <img src="https://raw.githubusercontent.com/solana-labs/token-list/main/assets/mainnet/So11111111111111111111111111111111111111112/logo.png" class="w-10 h-10 rounded-full shadow-lg">
                            <div>
                                <p class="font-bold text-sm">Solana</p>
                                <p class="text-[10px] text-gray-500 font-bold">SOL</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p id="balance-sol" class="font-bold text-sm">0.00 SOL</p>
                            <p id="balance-usd-sub" class="text-[10px] text-gray-500 font-medium">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Send -->
                <div id="view-send" class="hidden animate__animated animate__fadeIn">
                    <h2 class="text-xl font-bold mb-6">Send SOL</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-2 block">Recipient Username</label>
                            <input type="text" id="send-to" placeholder="e.g. MasterBanker" class="w-full bg-[#222] p-4 rounded-xl border border-transparent">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase ml-1 mb-2 block">Amount</label>
                            <div class="relative">
                                <input type="number" id="send-amount" placeholder="0.00" class="w-full bg-[#222] p-4 rounded-xl border border-transparent pr-12">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold text-purple-400">SOL</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="transferFunds()" id="transfer-btn" class="w-full bg-[#ab9ff2] text-black font-bold py-4 rounded-xl mt-8 shadow-lg">Send Now</button>
                    <button onclick="switchView('dashboard')" class="w-full text-gray-500 mt-4 text-sm font-semibold">Cancel</button>
                </div>

                <!-- History -->
                <div id="view-history" class="hidden animate__animated animate__fadeIn">
                    <h2 class="text-xl font-bold mb-6">Activity</h2>
                    <div id="history-list" class="space-y-3"></div>
                </div>
            </div>

            <nav class="h-20 bg-black border-t border-white/5 flex items-center justify-around">
                <button onclick="switchView('dashboard')" class="nav-btn p-3 tab-active" id="btn-dash"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></button>
                <button onclick="switchView('history')" class="nav-btn p-3 text-gray-600" id="btn-hist"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>
            </nav>
        </div>

        <div id="toast" class="fixed bottom-24 left-6 right-6 p-4 bg-white text-black rounded-xl font-bold text-center text-sm transform translate-y-40 transition-transform duration-300 z-[100] shadow-2xl"></div>
    </div>

    <script>
        const supabaseConfig = {
            url: "https://ehhgrwcgckcqbjoxitsx.supabase.co",
            key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGdyd2NnY2tjcWJqb3hpdHN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMjg3ODksImV4cCI6MjA4MzcwNDc4OX0.fJIZ0-Fu3wFIZmI3pFwJ83IH_sWRMWc1K6B3GQvLU1k"
        };

        const sb = supabase.createClient(supabaseConfig.url, supabaseConfig.key);
        const MASTER_USER = "MasterBanker";
        const SOL_PRICE = 145.50;
        let user = null;

        function toggleAuth(mode) {
            ['login-form', 'signup-form'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`${mode}-form`).classList.remove('hidden');
        }

        function switchView(view) {
            ['view-dashboard', 'view-send', 'view-history'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.getElementById('btn-dash').className = `nav-btn p-3 ${view === 'dashboard' ? 'tab-active' : 'text-gray-600'}`;
            document.getElementById('btn-hist').className = `nav-btn p-3 ${view === 'history' ? 'tab-active' : 'text-gray-600'}`;
            if(view === 'history') loadHistory();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-40');
            setTimeout(() => t.classList.add('translate-y-40'), 3000);
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function showSQL() {
            const sql = `-- EMERGENCY FIX SCRIPT: Run this to remove 'phrase' column issues
-- Step 1: Ensure table structure is correct
CREATE TABLE IF NOT EXISTS public.profiles (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  username text UNIQUE NOT NULL,
  password text NOT NULL,
  balance float8 DEFAULT 0,
  created_at timestamptz DEFAULT now()
);

-- Step 2: COMPLETELY REMOVE the 'phrase' column if it exists to avoid NOT NULL errors
DO $$ 
BEGIN 
  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='profiles' AND column_name='phrase') THEN
    ALTER TABLE public.profiles DROP COLUMN phrase;
  END IF;
END $$;

-- Step 3: Ensure password is NOT NULL and has no bad constraints
ALTER TABLE public.profiles ALTER COLUMN password SET NOT NULL;

-- Step 4: Transactions table
CREATE TABLE IF NOT EXISTS public.transactions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  from_id uuid REFERENCES public.profiles(id),
  to_id uuid REFERENCES public.profiles(id),
  from_username text,
  to_username text,
  amount float8 NOT NULL,
  created_at timestamptz DEFAULT now()
);

-- Step 5: Global Permissions
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Public Full Access Profiles" ON public.profiles;
CREATE POLICY "Public Full Access Profiles" ON public.profiles FOR ALL USING (true) WITH CHECK (true);

DROP POLICY IF EXISTS "Public Full Access Transactions" ON public.transactions;
CREATE POLICY "Public Full Access Transactions" ON public.transactions FOR ALL USING (true) WITH CHECK (true);

-- Step 6: FORCE SERVER REFRESH
NOTIFY pgrst, 'reload schema';
COMMIT;`;
            
            document.getElementById('sql-content').innerText = sql;
            document.getElementById('sql-modal').classList.remove('hidden');
        }

        function copySQL() {
            const content = document.getElementById('sql-content').innerText;
            const el = document.createElement('textarea');
            el.value = content;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("Copied! Paste and RUN in Supabase SQL Editor.");
        }

        async function signUp() {
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            if (!username || !password) return showToast("All fields required");
            
            toggleLoading(true);

            try {
                const { data: existingUser, error: checkError } = await sb
                    .from('profiles')
                    .select('username')
                    .eq('username', username)
                    .maybeSingle();
                
                if (checkError && checkError.code !== 'PGRST116') throw checkError;
                
                if (existingUser) {
                    toggleLoading(false);
                    return showToast("⚠️ Username already taken");
                }

                const initialBalance = (username === MASTER_USER) ? 5000 : 0;

                const { error: insertError } = await sb
                    .from('profiles')
                    .insert([{ 
                        username: username, 
                        password: password, 
                        balance: initialBalance 
                    }]);

                if (insertError) throw insertError;

                toggleLoading(false);
                showToast("Account Created! Login now.");
                toggleAuth('login');
            } catch (err) {
                console.error("Supabase Error:", err);
                toggleLoading(false);
                if (err.code === '23502') {
                    showToast("Column 'phrase' still blocking. Run NEW SQL!");
                } else if (err.code === 'PGRST204') {
                    showToast("Schema error: Refresh SQL setup!");
                } else {
                    showToast("Signup failed. Check SQL setup.");
                }
            }
        }

        async function signIn() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if(!username || !password) return showToast("Enter credentials");

            toggleLoading(true);
            try {
                const { data, error } = await sb.from('profiles')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();
                
                toggleLoading(false);
                if (error || !data) return showToast("Invalid username or password");

                user = data;
                initSession();
            } catch (err) {
                console.error(err);
                toggleLoading(false);
                showToast("Login error. Is the schema updated?");
            }
        }

        function initSession() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            document.getElementById('user-display').innerText = user.username;
            updateUI();
        }

        function updateUI() {
            const sol = user.balance || 0;
            const usd = sol * SOL_PRICE;
            document.getElementById('balance-usd').innerText = `$${usd.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('balance-sol').innerText = `${sol.toFixed(2)} SOL`;
            document.getElementById('balance-usd-sub').innerText = `$${usd.toLocaleString()}`;
        }

        async function transferFunds() {
            const to = document.getElementById('send-to').value.trim();
            const amount = parseFloat(document.getElementById('send-amount').value);

            if (!to || !amount || amount <= 0) return showToast("Enter valid details");
            if (amount > user.balance && user.username !== MASTER_USER) return showToast("Insufficient balance");
            if (to === user.username) return showToast("Cannot send to yourself");

            toggleLoading(true);
            try {
                const { data: recipient, error: rError } = await sb.from('profiles').select('*').eq('username', to).single();
                if (rError || !recipient) {
                    toggleLoading(false);
                    return showToast("Recipient not found");
                }

                if (user.username !== MASTER_USER) {
                    await sb.from('profiles').update({ balance: user.balance - amount }).eq('id', user.id);
                }
                
                await sb.from('profiles').update({ balance: recipient.balance + amount }).eq('id', recipient.id);
                
                await sb.from('transactions').insert([{ 
                    from_id: user.id, to_id: recipient.id, 
                    amount: amount, from_username: user.username, to_username: recipient.username
                }]);

                toggleLoading(false);
                showToast("Transaction Successful!");
                
                const { data: refreshed } = await sb.from('profiles').select('*').eq('id', user.id).single();
                user = refreshed;
                updateUI();
                switchView('dashboard');
            } catch (err) {
                toggleLoading(false);
                showToast("Transfer failed.");
            }
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = `<div class="flex justify-center py-10"><div class="loader"></div></div>`;
            try {
                const { data } = await sb.from('transactions')
                    .select('*')
                    .or(`from_id.eq.${user.id},to_id.eq.${user.id}`)
                    .order('created_at', { ascending: false });

                if (!data || data.length === 0) {
                    list.innerHTML = `<div class="text-center py-20 opacity-20 text-sm">No activity yet</div>`;
                    return;
                }

                list.innerHTML = data.map(tx => {
                    const isSent = tx.from_id === user.id;
                    return `
                    <div class="bg-[#1a1a1a] p-4 rounded-xl border border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${isSent ? 'text-orange-400 bg-orange-500/10' : 'text-green-400 bg-green-500/10'}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="${isSent ? 'M7 17L17 7M17 7H7M17 7v10' : 'M17 7L7 17M7 17h10M7 17V7'}"/></svg>
                            </div>
                            <div>
                                <p class="text-xs font-bold">${isSent ? 'To: ' + tx.to_username : 'From: ' + tx.from_username}</p>
                                <p class="text-[9px] text-gray-500 font-bold uppercase">${new Date(tx.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <p class="text-xs font-bold ${isSent ? 'text-white' : 'text-green-400'}">${isSent ? '-' : '+'}${tx.amount.toFixed(2)} SOL</p>
                    </div>`;
                }).join('');
            } catch (err) {
                list.innerHTML = `<div class="text-center py-20 text-red-500 text-xs">Error loading history</div>`;
            }
        }

        function signOut() { location.reload(); }
    </script>
</body>
</html>
