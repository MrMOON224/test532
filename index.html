<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Nexus Vault</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --blue: #3b82f6;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #000;
            color: white;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .view {
            height: calc(100vh - 160px - var(--safe-bottom));
            overflow-y: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .view::-webkit-scrollbar { display: none; }

        .tab-active {
            color: var(--blue) !important;
            position: relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background: var(--blue);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--blue);
        }

        .nft-card {
            aspect-ratio: 1/1;
            background-size: cover;
            background-position: center;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-animate { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>

<body class="flex justify-center items-center">

<div class="w-full max-w-md h-full bg-[#050505] shadow-2xl overflow-hidden relative flex flex-col border-x border-white/5">

    <!-- ONBOARDING -->
    <div id="onboard" class="absolute inset-0 z-[100] bg-[#050505] flex flex-col items-center justify-center p-10 hidden">
        <div class="text-center mb-12">
            <div class="w-24 h-24 bg-blue-600 rounded-[2.5rem] mx-auto mb-6 flex items-center justify-center text-4xl shadow-xl shadow-blue-500/20">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h1 class="text-5xl font-black mb-3 tracking-tighter italic">NEXUS</h1>
            <p class="text-gray-400 text-sm">Secure Peer-to-Peer Vault Architecture</p>
        </div>

        <!-- Create Section -->
        <div id="onboarding-main" class="w-full space-y-4">
            <div class="glass p-4 rounded-3xl mb-2">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2 px-1">Vault Identity</p>
                <input id="new-vault-name" placeholder="Enter Vault Name..." class="bg-transparent w-full p-2 font-bold text-white outline-none border-b border-white/10 focus:border-blue-500 transition-colors" value="Personal Vault"/>
            </div>
            <button class="w-full py-5 rounded-3xl btn-gradient font-black text-xl mb-4 active:scale-95 transition-all" onclick="createNewWallet()">Generate Vault</button>
            <button class="w-full py-5 rounded-3xl glass font-bold active:scale-95 transition-all" onclick="showImportBox()">Import Existing</button>
        </div>

        <div id="import-box" class="hidden w-full mt-6 animate-fadeIn">
            <input id="import-id" placeholder="Master Key or bc1q..." class="glass w-full p-4 rounded-2xl font-mono text-blue-400 outline-none mb-3 border-white/10"/>
            <p class="text-[10px] text-gray-500 mb-3 px-2">Tip: Use 'MASTER_ADMIN_2024' for the master account.</p>
            <div class="flex gap-2">
                <button class="flex-1 glass py-4 rounded-2xl font-black text-gray-400" onclick="hideImportBox()">Back</button>
                <button class="flex-[2] glass py-4 rounded-2xl font-black text-blue-500" onclick="importWallet()">Sync Node</button>
            </div>
        </div>
    </div>

    <!-- MAIN UI -->
    <div id="app" class="hidden flex flex-col h-full">

        <!-- HEADER -->
        <header class="p-6 pt-[calc(1.5rem+var(--safe-top))] glass flex justify-between items-center border-b border-white/5">
            <div>
                <p id="wallet-name" class="font-black text-xl tracking-tight">Vault</p>
                <div class="text-[10px] text-emerald-500 flex items-center gap-1 font-bold uppercase tracking-widest">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> Backend Synced
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="copyAddress()" class="glass w-10 h-10 rounded-xl flex items-center justify-center active:scale-90 transition-all">
                    <i class="fa-regular fa-copy text-gray-400"></i>
                </button>
                <button onclick="toggleModal('settings-modal')" class="glass w-10 h-10 rounded-xl flex items-center justify-center active:scale-90 transition-all">
                    <i class="fa-solid fa-sliders text-gray-400"></i>
                </button>
            </div>
        </header>

        <!-- VIEW: WALLET -->
        <main id="wallet-view" class="view px-6 pt-6 active-view">
            <p class="uppercase text-gray-600 text-[10px] font-black tracking-[0.2em] mb-1">Total Assets</p>
            <div class="flex items-end gap-3 mb-8">
                <h1 id="total" class="text-5xl font-black tracking-tighter">$0.00</h1>
                <button onclick="togglePrivacy()" class="mb-2 text-gray-500"><i id="privacy-icon" class="fa-regular fa-eye"></i></button>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-10">
                <button onclick="openSendModal()" class="flex flex-col items-center">
                    <div class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-blue-400"><i class="fa-solid fa-arrow-up"></i></div>
                    <span class="text-[10px] mt-2 font-black opacity-60">SEND</span>
                </button>
                <button onclick="copyAddress()" class="flex flex-col items-center">
                    <div class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-emerald-400"><i class="fa-solid fa-qrcode"></i></div>
                    <span class="text-[10px] mt-2 font-black opacity-60">RECEIVE</span>
                </button>
                <button onclick="switchTab('market')" class="flex flex-col items-center">
                    <div class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-orange-400"><i class="fa-solid fa-repeat"></i></div>
                    <span class="text-[10px] mt-2 font-black opacity-60">SWAP</span>
                </button>
                <button onclick="switchTab('nfts')" class="flex flex-col items-center">
                    <div class="glass w-14 h-14 rounded-2xl flex items-center justify-center text-purple-400"><i class="fa-solid fa-shapes"></i></div>
                    <span class="text-[10px] mt-2 font-black opacity-60">NFTS</span>
                </button>
            </div>

            <div id="assets" class="space-y-3"></div>

            <h2 class="mt-10 font-black text-lg tracking-tight flex items-center justify-between">
                Global Ledger History
                <i class="fa-solid fa-chevron-right text-[10px] opacity-30"></i>
            </h2>
            <div id="history" class="mt-4 pb-24 space-y-3"></div>
        </main>

        <!-- MARKET VIEW -->
        <main id="market-view" class="view px-6 pt-6 hidden">
            <h2 class="text-3xl font-black mb-6">Market</h2>
            <div id="market-list" class="space-y-4 pb-24"></div>
        </main>

        <!-- NFT VIEW -->
        <main id="nfts-view" class="view px-6 pt-6 hidden">
            <h2 class="text-3xl font-black mb-6">Collectibles</h2>
            <div class="grid grid-cols-2 gap-4 pb-24">
                <div class="glass p-2 rounded-[2rem]">
                    <div class="nft-card rounded-[1.5rem] mb-3 bg-gradient-to-br from-purple-600 to-blue-600"></div>
                    <p class="px-2 font-bold text-xs">Nexus Punk #402</p>
                </div>
            </div>
        </main>

        <!-- NEWS VIEW -->
        <main id="news-view" class="view px-6 pt-6 hidden">
            <h2 class="text-3xl font-black mb-6">Insights</h2>
            <div id="news-list" class="space-y-4 pb-24">
                <div class="glass p-5 rounded-3xl border-blue-500/20">
                    <span class="text-[10px] font-black text-blue-400 uppercase tracking-widest">System Message</span>
                    <p class="font-bold mt-2">P2P Transfers between vaults are now zero-fee.</p>
                </div>
            </div>
        </main>

        <!-- TAB BAR -->
        <footer class="absolute bottom-0 left-0 right-0 h-20 glass px-6 flex justify-between items-center pb-[var(--safe-bottom)] border-t border-white/5">
            <button class="nav tab-active flex flex-col items-center flex-1" onclick="switchTab('wallet')">
                <i class="fa-solid fa-wallet text-xl"></i>
                <div class="text-[9px] mt-1 font-black uppercase opacity-60">Vault</div>
            </button>
            <button class="nav text-gray-500 flex flex-col items-center flex-1" onclick="switchTab('market')">
                <i class="fa-solid fa-chart-line text-xl"></i>
                <div class="text-[9px] mt-1 font-black uppercase opacity-60">Market</div>
            </button>
            <button class="nav text-gray-500 flex flex-col items-center flex-1" onclick="switchTab('nfts')">
                <i class="fa-solid fa-layer-group text-xl"></i>
                <div class="text-[9px] mt-1 font-black uppercase opacity-60">NFTs</div>
            </button>
            <button class="nav text-gray-500 flex flex-col items-center flex-1" onclick="switchTab('news')">
                <i class="fa-solid fa-rss text-xl"></i>
                <div class="text-[9px] mt-1 font-black uppercase opacity-60">News</div>
            </button>
        </footer>
    </div>

    <!-- MODAL: SEND -->
    <div id="send-modal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('send-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 glass rounded-t-[3rem] p-8 modal-animate pb-[calc(2rem+var(--safe-bottom))]">
            <h3 class="text-2xl font-black mb-6">P2P Transfer</h3>
            <div class="space-y-4">
                <div class="glass p-4 rounded-2xl">
                    <p class="text-[10px] font-black opacity-40 mb-1">RECEIVING VAULT ID</p>
                    <input id="send-to" placeholder="bc1q..." class="bg-transparent w-full font-mono text-blue-400 outline-none text-sm" />
                </div>
                <div class="glass p-4 rounded-2xl">
                    <p class="text-[10px] font-black opacity-40 mb-1">AMOUNT TO BROADCAST</p>
                    <div class="flex justify-between items-center">
                        <input id="send-amt" type="number" placeholder="0.00" class="bg-transparent w-1/2 font-black text-2xl outline-none" />
                        <select id="send-asset" class="bg-transparent font-black text-blue-400 outline-none">
                            <option value="BTC">BTC</option>
                            <option value="ETH">ETH</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>
                </div>
                <button id="send-btn" class="w-full py-5 rounded-3xl btn-gradient font-black text-xl mt-4" onclick="executeP2PTransfer()">Sync Transfer to Server</button>
            </div>
        </div>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleModal('settings-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 glass rounded-t-[3rem] p-8 modal-animate pb-[calc(2rem+var(--safe-bottom))]">
            <h3 class="text-2xl font-black mb-6">Vault Config</h3>
            <div class="space-y-3">
                <button onclick="copyAddress()" class="w-full glass p-5 rounded-2xl flex justify-between font-bold text-blue-400">
                    Vault ID: <span class="opacity-50 font-mono text-xs" id="display-id">...</span>
                </button>
                <button onclick="logout()" class="w-full glass p-5 rounded-2xl flex justify-between font-bold text-red-400">
                    Disconnect Session <i class="fa-solid fa-power-off opacity-40"></i>
                </button>
            </div>
        </div>
    </div>

</div>

<!-- TOASTS -->
<div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[300] w-full max-w-[280px] space-y-2 pointer-events-none"></div>

<script>
const SUPABASE_URL = "https://tmvimacikrnrizxtcesf.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtdmltYWNpa3Jucml6eHRjZXNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDc5NzgsImV4cCI6MjA4MzY4Mzk3OH0.dwh4CWwxE53hbhgjYqOqHZYa1tNyUKNZvdb6Kq5pLC4";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const MASTER_KEY = "MASTER_ADMIN_2024";

let walletId = localStorage.getItem("nexus_wallet");
let privacy = false;
let user = {
    name: "Standard Vault",
    balances : {
        BTC: {amount:0, rate:67000, icon:"fa-brands fa-bitcoin", color:"text-orange-400"},
        ETH: {amount:0, rate:3500, icon:"fa-brands fa-ethereum", color:"text-indigo-400"},
        USDT:{amount:0, rate:1, icon:"fa-solid fa-dollar-sign", color:"text-green-400"},
    },
    history:[]
};

// INITIALIZE MASTER ACCOUNT PROFILE
const masterProfile = {
    name: "Master Nexus Account",
    balances: {
        BTC: {amount:10, rate:67000, icon:"fa-brands fa-bitcoin", color:"text-orange-400"},
        ETH: {amount:50, rate:3500, icon:"fa-brands fa-ethereum", color:"text-indigo-400"},
        USDT:{amount:130000, rate:1, icon:"fa-solid fa-dollar-sign", color:"text-green-400"},
    },
    history:[]
};

window.onload = async () => {
    if (!walletId) {
        document.getElementById("onboard").classList.remove("hidden");
    } else {
        showApp();
        await loadWallet();
        initRealtime();
    }
};

async function createNewWallet() {
    const nameInput = document.getElementById("new-vault-name").value.trim();
    if (!nameInput) return showToast("Please name your vault");

    const chars = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";
    let addr = "bc1q";
    for (let i=0;i<38;i++) addr += chars[Math.floor(Math.random()*chars.length)];
    
    walletId = addr;
    user.name = nameInput;

    localStorage.setItem("nexus_wallet", addr);
    await db.from("wallets").insert({ id: addr, data: user });
    
    showApp();
    showToast(`Vault "${nameInput}" Synced`);
}

async function loadWallet(){
    try {
        let {data, error} = await db.from("wallets").select("data").eq("id", walletId).maybeSingle();
        
        if (data) {
            user = data.data;
        } else if (walletId === MASTER_KEY) {
            user = masterProfile;
            await db.from("wallets").upsert({ id: MASTER_KEY, data: user });
        } else {
            // Handle if ID is set in localStorage but not in DB
            localStorage.clear();
            location.reload();
        }
        render();
    } catch(e) { console.error(e); render(); }
}

function initRealtime(){
    db.channel("vault_sync").on("postgres_changes",
        {event:"UPDATE", schema:"public", table:"wallets"},
        (p) => { 
            if(p.new && p.new.id === walletId) {
                user = p.new.data;
                render();
            }
        }
    ).subscribe();
}

function render(){
    document.getElementById("wallet-name").innerText = user.name;
    document.getElementById("display-id").innerText = walletId.substring(0,10)+"...";
    
    let total = 0;
    for (let k in user.balances) total += user.balances[k].amount * user.balances[k].rate;
    document.getElementById("total").innerText = privacy ? "••••••" : "$" + total.toLocaleString(undefined, {minimumFractionDigits: 2});

    document.getElementById("assets").innerHTML = Object.entries(user.balances).map(([k,v])=>`
        <div class="glass p-4 rounded-3xl flex justify-between items-center border-white/5">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-white/5 flex items-center justify-center">
                    <i class="${v.icon} text-2xl ${v.color}"></i>
                </div>
                <div>
                    <p class="font-black text-sm">${k}</p>
                    <p class="text-[10px] opacity-40 font-bold uppercase tracking-wider">${v.amount.toFixed(4)} ${k}</p>
                </div>
            </div>
            <div class="text-right">
                <p class="font-black text-sm">${privacy?"••••":"$"+(v.amount*v.rate).toLocaleString()}</p>
            </div>
        </div>
    `).join("");

    document.getElementById("history").innerHTML = (user.history && user.history.length) ? 
    user.history.slice(-15).reverse().map(h => `
        <div class="glass p-4 rounded-2xl flex justify-between items-center text-[11px] border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center">
                    <i class="fa-solid ${h.type==='Sent'?'fa-arrow-up text-red-400':'fa-arrow-down text-emerald-400'}"></i>
                </div>
                <div>
                    <p class="font-black">${h.type} ${h.asset}</p>
                    <p class="opacity-30">P2P: ${h.party.substring(0,8)}...</p>
                </div>
            </div>
            <p class="font-black ${h.type==='Sent'?'text-red-400':'text-emerald-400'}">
                ${h.type==='Sent'?'-':'+'}${h.amount}
            </p>
        </div>
    `).join("") : `<p class="text-center py-10 opacity-20 text-xs font-black italic">NO SERVER ACTIVITY DETECTED</p>`;

    document.getElementById("market-list").innerHTML = [
        {id:'BTC', p:67000, c:'+1.2%'}, {id:'ETH', p:3500, c:'+0.8%'}, {id:'USDT', p:1.00, c:'0.0%'}
    ].map(m => `
        <div class="glass p-5 rounded-3xl flex justify-between items-center border-white/5">
            <span class="font-bold">${m.id} / USD</span>
            <div class="text-right">
                <p class="font-black">$${m.p.toLocaleString()}</p>
                <p class="text-[10px] text-emerald-400 font-bold">${m.c}</p>
            </div>
        </div>
    `).join("");
}

async function executeP2PTransfer(){
    const btn = document.getElementById('send-btn');
    let toId = document.getElementById('send-to').value.trim();
    let amt = parseFloat(document.getElementById('send-amt').value);
    let asset = document.getElementById('send-asset').value;

    if(!toId || isNaN(amt) || amt <= 0) return showToast("Invalid Inputs");
    if(user.balances[asset].amount < amt) return showToast("Balance too low");
    if(toId === walletId) return showToast("Cannot send to self");

    btn.disabled = true;
    btn.innerText = "Broadcasting...";

    try {
        // 1. Fetch Receiver safely using maybeSingle
        let { data: receiverDoc, error: fetchError } = await db.from("wallets").select("data").eq("id", toId).maybeSingle();
        
        if(fetchError || !receiverDoc) {
            btn.disabled = false;
            btn.innerText = "Sync Transfer to Server";
            return showToast("Receiver Vault not found");
        }

        let receiverData = receiverDoc.data;

        // 2. Local State Prep
        const senderUpdate = JSON.parse(JSON.stringify(user));
        const receiverUpdate = JSON.parse(JSON.stringify(receiverData));

        senderUpdate.balances[asset].amount -= amt;
        senderUpdate.history.push({ type: "Sent", asset, amount: amt, party: toId, time: Date.now() });

        receiverUpdate.balances[asset].amount += amt;
        receiverUpdate.history.push({ type: "Received", asset, amount: amt, party: walletId, time: Date.now() });

        // 3. Sequential Update (More stable for P2P)
        const { error: e1 } = await db.from("wallets").update({ data: senderUpdate }).eq("id", walletId);
        if(e1) throw e1;

        const { error: e2 } = await db.from("wallets").update({ data: receiverUpdate }).eq("id", toId);
        if(e2) throw e2;

        // Update local user object immediately
        user = senderUpdate;
        
        toggleModal('send-modal');
        showToast(`Success: ${amt} ${asset} Transferred`);
    } catch(err) {
        console.error(err);
        showToast("Ledger Sync Failure");
    } finally {
        btn.disabled = false;
        btn.innerText = "Sync Transfer to Server";
        render();
    }
}

function switchTab(t){
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.getElementById(`${t}-view`).classList.remove('hidden');
    document.querySelectorAll('.nav').forEach(n => n.classList.remove('tab-active'));
    if (event) event.currentTarget.classList.add('tab-active');
}

function toggleModal(id){ document.getElementById(id).classList.toggle('hidden'); }
function openSendModal(){ toggleModal('send-modal'); }
function showToast(m){
    const t = document.createElement('div');
    t.className = "glass px-6 py-3 rounded-2xl text-xs font-black text-blue-400 border-blue-500/20 shadow-lg";
    t.innerText = m;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 3000);
}
function copyAddress(){
    const el = document.createElement('textarea');
    el.value = walletId;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast("ID Copied to Clipboard");
}
function logout(){ localStorage.clear(); location.reload(); }
function togglePrivacy(){ privacy = !privacy; render(); }
function showApp(){ 
    document.getElementById("onboard").classList.add("hidden"); 
    document.getElementById("app").classList.remove("hidden"); 
}
function showImportBox(){ 
    document.getElementById("import-box").classList.remove("hidden"); 
    document.getElementById("onboarding-main").classList.add("hidden"); 
}
function hideImportBox(){ 
    document.getElementById("import-box").classList.add("hidden"); 
    document.getElementById("onboarding-main").classList.remove("hidden"); 
}
async function importWallet(){
    let id = document.getElementById("import-id").value.trim();
    if(!id) return showToast("Enter ID");
    walletId = id; 
    localStorage.setItem("nexus_wallet", id);
    await loadWallet(); 
    showApp();
    initRealtime();
}
</script>
</body>
</html>
